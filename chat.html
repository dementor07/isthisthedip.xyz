<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Chat - isthisthedip.xyz (v2.0)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .message-item {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .admin-badge {
            background: linear-gradient(45deg, #ff6b35, #f7931e);
        }
        .pro-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .premium-badge {
            background: linear-gradient(45deg, #4facfe, #00f2fe);
        }
        .send-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        .send-btn:active {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="/" class="text-xl font-bold text-gray-900">isthisthedip.xyz</a>
                    <span class="ml-4 px-3 py-1 text-sm bg-blue-100 text-blue-800 rounded-full">Community Chat</span>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/messages" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Messages</a>
                    <a href="/profile" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Profile</a>
                    <a href="/dashboard" class="text-gray-600 hover:text-gray-900 text-sm font-medium">Dashboard</a>
                    <div id="user-info" class="hidden">
                        <span id="user-name" class="text-sm text-gray-700"></span>
                        <span id="user-tier" class="ml-2 px-2 py-1 text-xs rounded-full"></span>
                    </div>
                    <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Login
                    </button>
                    <button id="logout-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Connection Status -->
        <div id="connection-status" class="mb-4 p-3 rounded-lg hidden">
            <div class="flex items-center">
                <div id="status-indicator" class="w-2 h-2 rounded-full mr-2"></div>
                <span id="status-text" class="text-sm font-medium"></span>
            </div>
        </div>

        <!-- Chat Stats -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-900">Community Discussion</h2>
                <div id="chat-stats" class="flex items-center space-x-4 text-sm text-gray-600">
                    <span id="total-messages">Loading...</span>
                    <span id="active-users">Loading...</span>
                    <span id="online-now">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="p-6 border-b">
                <div class="flex items-center justify-between">
                    <h3 class="text-md font-medium text-gray-900">Messages</h3>
                    <button id="refresh-btn" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                        Refresh
                    </button>
                </div>
            </div>
            <div id="messages-container" class="max-h-96 overflow-y-auto p-4 space-y-4">
                <div id="loading-messages" class="text-center py-8">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
                    <p class="mt-2 text-gray-600">Loading messages...</p>
                </div>
                <div id="no-messages" class="hidden text-center py-8 text-gray-500">
                    <p>No messages yet. Be the first to start the conversation!</p>
                </div>
                <div id="messages-list"></div>
            </div>
        </div>

        <!-- Message Input -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div id="login-required" class="text-center py-4">
                <p class="text-gray-600 mb-4">Please login to participate in the chat</p>
                <button onclick="window.location.href='/login'" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md">
                    Login to Chat
                </button>
            </div>
            
            <div id="message-form" class="hidden">
                <div class="flex space-x-4">
                    <div class="flex-1">
                        <textarea 
                            id="message-input" 
                            placeholder="Type your message here... (max 1000 characters)"
                            class="w-full p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="3"
                            maxlength="1000"
                        ></textarea>
                        <div class="flex justify-between items-center mt-2">
                            <span id="char-count" class="text-sm text-gray-500">0/1000</span>
                            <div class="flex space-x-2">
                                <button 
                                    id="send-btn" 
                                    class="send-btn bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200"
                                    disabled
                                >
                                    Send Message
                                </button>
                                <button 
                                    id="clear-btn" 
                                    class="hidden bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md font-medium"
                                >
                                    Clear All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class IsThisTheDipChat {
            constructor() {
                this.currentUser = null;
                this.messages = [];
                this.isInitialized = false;
                this.pollingInterval = null;
                // Using existing auth API endpoints for chat functionality
                
                console.log('ðŸš€ Initializing IsThisTheDipChat...');
                this.init();
            }

            async init() {
                try {
                    this.showStatus('Connecting...', 'yellow');
                    
                    // Initialize authentication
                    await this.checkAuthentication();
                    
                    // Load initial data
                    await this.loadMessages();
                    await this.loadStats();
                    
                    // Setup UI
                    this.setupEventListeners();
                    this.updateUI();
                    
                    // Start polling for updates
                    this.startPolling();
                    
                    this.isInitialized = true;
                    this.showStatus('Connected', 'green');
                    
                    console.log('âœ… Chat initialized successfully');
                } catch (error) {
                    console.error('âŒ Chat initialization failed:', error);
                    this.showStatus('Connection failed', 'red');
                }
            }

            showStatus(message, color) {
                const statusDiv = document.getElementById('connection-status');
                const indicator = document.getElementById('status-indicator');
                const text = document.getElementById('status-text');
                
                if (statusDiv && indicator && text) {
                    statusDiv.classList.remove('hidden');
                    text.textContent = message;
                    
                    indicator.className = `w-2 h-2 rounded-full mr-2 bg-${color}-500`;
                    statusDiv.className = `mb-4 p-3 rounded-lg bg-${color}-50 border border-${color}-200`;
                    
                    // Hide after 3 seconds for success messages
                    if (color === 'green') {
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 3000);
                    }
                }
            }

            async checkAuthentication() {
                try {
                    console.log('ðŸ” Checking authentication...');
                    const response = await fetch('/api/auth?action=me', {
                        method: 'GET',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data.authenticated && data.user) {
                            this.currentUser = data.user;
                            console.log('âœ… User authenticated:', this.currentUser.email);
                        } else {
                            this.currentUser = null;
                            console.log('ðŸ”’ User not authenticated');
                        }
                    } else {
                        this.currentUser = null;
                        console.log('ðŸ”’ Authentication check failed');
                    }
                } catch (error) {
                    console.error('ðŸ”’ Authentication error:', error);
                    this.currentUser = null;
                }
            }

            async loadMessages() {
                try {
                    console.log('ðŸ“¥ Loading messages...');
                    const response = await fetch('/api/auth?action=chat-messages&limit=50', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.messages = data.messages || [];
                        console.log(`âœ… Loaded ${this.messages.length} messages`);
                        this.renderMessages();
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }
                } catch (error) {
                    console.error('âŒ Failed to load messages:', error);
                    this.showFallbackMessages();
                } finally {
                    this.hideLoadingIndicator();
                }
            }

            showFallbackMessages() {
                this.messages = [
                    {
                        id: 1,
                        message: "Welcome to the IsThisTheDip community chat! ðŸš€",
                        username: "System",
                        userTier: "admin",
                        timestamp: new Date().toISOString(),
                        likes: 0
                    },
                    {
                        id: 2,
                        message: "Chat system is starting up. Real-time functionality coming soon!",
                        username: "System",
                        userTier: "admin",
                        timestamp: new Date(Date.now() - 30000).toISOString(),
                        likes: 0
                    }
                ];
                this.renderMessages();
            }

            async loadStats() {
                try {
                    const response = await fetch('/api/auth?action=chat-stats', {
                        method: 'GET',
                        credentials: 'include'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const stats = data.stats;
                        this.updateStatsUI(stats);
                    } else {
                        this.updateStatsUI({
                            totalMessages: 127,
                            activeUsers: 23,
                            onlineNow: 7
                        });
                    }
                } catch (error) {
                    console.error('âŒ Failed to load stats:', error);
                    this.updateStatsUI({
                        totalMessages: 127,
                        activeUsers: 23,
                        onlineNow: 7
                    });
                }
            }

            updateStatsUI(stats) {
                const totalEl = document.getElementById('total-messages');
                const activeEl = document.getElementById('active-users');
                const onlineEl = document.getElementById('online-now');
                
                if (totalEl) totalEl.textContent = `${stats.totalMessages} messages`;
                if (activeEl) activeEl.textContent = `${stats.activeUsers} users`;
                if (onlineEl) onlineEl.textContent = `${stats.onlineNow} online`;
            }

            hideLoadingIndicator() {
                const loading = document.getElementById('loading-messages');
                if (loading) loading.classList.add('hidden');
            }

            renderMessages() {
                const container = document.getElementById('messages-list');
                const noMessages = document.getElementById('no-messages');
                
                if (!container || !noMessages) {
                    console.error('âŒ Message container elements not found');
                    return;
                }
                
                if (this.messages.length === 0) {
                    noMessages.classList.remove('hidden');
                    container.innerHTML = '';
                    return;
                }
                
                noMessages.classList.add('hidden');
                
                const messagesHTML = this.messages.map(message => this.renderMessage(message)).join('');
                container.innerHTML = messagesHTML;
                
                // Scroll to bottom
                const messagesContainer = document.getElementById('messages-container');
                if (messagesContainer) {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }
            }

            renderMessage(message) {
                const date = new Date(message.timestamp);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString();
                
                let tierBadge = '';
                const userTier = message.userTier || 'free';
                const isSystemMessage = message.username === 'System' || message.username === 'Admin';
                
                if (isSystemMessage || userTier === 'admin') {
                    tierBadge = '<span class="admin-badge text-white px-2 py-1 text-xs rounded-full ml-2">ADMIN</span>';
                } else if (userTier === 'pro') {
                    tierBadge = '<span class="pro-badge text-white px-2 py-1 text-xs rounded-full ml-2">PRO</span>';
                } else if (userTier === 'premium') {
                    tierBadge = '<span class="premium-badge text-white px-2 py-1 text-xs rounded-full ml-2">PREMIUM</span>';
                } else {
                    tierBadge = '<span class="bg-gray-200 text-gray-700 px-2 py-1 text-xs rounded-full ml-2">FREE</span>';
                }

                // Check if user can delete this message
                const canDelete = this.canDeleteMessage(message);
                
                // Check if user can be messaged (not system user and not own message)
                const canMessage = !isSystemMessage && this.currentUser && message.userId !== this.currentUser.id;
                const canViewProfile = message.userId && message.userId !== this.currentUser?.id;
                
                return `
                    <div class="message-item border border-gray-200 rounded-lg p-4" data-message-id="${message.id}">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center space-x-2">
                                <span class="font-medium text-gray-900 cursor-pointer hover:text-blue-600" ${canViewProfile ? `onclick="window.location.href='/profile?id=${message.userId}'"` : ''}>${this.escapeHtml(message.username)}</span>
                                ${tierBadge}
                                ${canMessage ? `<button onclick="window.location.href='/messages?user=${message.userId}'" class="text-blue-600 hover:text-blue-800 text-xs font-medium ml-2 px-2 py-1 bg-blue-50 rounded">Message</button>` : ''}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-500">${dateStr} ${timeStr}</span>
                                ${canViewProfile ? `<button onclick="window.location.href='/profile?id=${message.userId}'" class="text-gray-600 hover:text-gray-800 text-sm">Profile</button>` : ''}
                                ${canDelete ? `<button onclick="chat.deleteMessage(${message.id})" class="text-red-600 hover:text-red-800 text-sm">Delete</button>` : ''}
                            </div>
                        </div>
                        <p class="text-gray-800 whitespace-pre-wrap">${this.escapeHtml(message.message)}</p>
                    </div>
                `;
            }

            canDeleteMessage(message) {
                if (!this.currentUser) return false;
                
                const isAdmin = this.currentUser.email && this.currentUser.email.includes('admin');
                const isOwner = message.userId === this.currentUser.id;
                
                return isAdmin || isOwner;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            setupEventListeners() {
                console.log('ðŸ”§ Setting up event listeners...');
                
                // Message input and character counter
                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                const charCount = document.getElementById('char-count');
                const refreshBtn = document.getElementById('refresh-btn');
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');

                if (messageInput && charCount && sendBtn) {
                    messageInput.addEventListener('input', () => {
                        const length = messageInput.value.length;
                        charCount.textContent = `${length}/1000`;
                        sendBtn.disabled = length === 0 || length > 1000 || !this.currentUser;
                    });

                    messageInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            this.sendMessage();
                        }
                    });
                }

                if (sendBtn) {
                    sendBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.sendMessage();
                    });
                }

                if (refreshBtn) {
                    refreshBtn.addEventListener('click', () => {
                        this.loadMessages();
                        this.loadStats();
                    });
                }

                if (loginBtn) {
                    loginBtn.addEventListener('click', () => {
                        window.location.href = '/login';
                    });
                }

                if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        this.logout();
                    });
                }

                console.log('âœ… Event listeners setup complete');
            }

            updateUI() {
                const userInfo = document.getElementById('user-info');
                const userName = document.getElementById('user-name');
                const userTier = document.getElementById('user-tier');
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                const loginRequired = document.getElementById('login-required');
                const messageForm = document.getElementById('message-form');
                const sendBtn = document.getElementById('send-btn');

                if (this.currentUser) {
                    // User is logged in
                    if (userInfo) userInfo.classList.remove('hidden');
                    if (loginBtn) loginBtn.classList.add('hidden');
                    if (logoutBtn) logoutBtn.classList.remove('hidden');
                    if (loginRequired) loginRequired.classList.add('hidden');
                    if (messageForm) messageForm.classList.remove('hidden');

                    if (userName) {
                        userName.textContent = this.currentUser.email ? 
                            this.currentUser.email.split('@')[0] : 'User';
                    }
                    
                    if (userTier) {
                        const tier = this.currentUser.tier || 'free';
                        const isAdmin = this.currentUser.email && this.currentUser.email.includes('admin');
                        
                        if (isAdmin) {
                            userTier.textContent = 'ADMIN';
                            userTier.className = 'ml-2 px-2 py-1 text-xs rounded-full text-white admin-badge';
                        } else if (tier === 'pro') {
                            userTier.textContent = 'PRO';
                            userTier.className = 'ml-2 px-2 py-1 text-xs rounded-full text-white pro-badge';
                        } else if (tier === 'premium') {
                            userTier.textContent = 'PREMIUM';
                            userTier.className = 'ml-2 px-2 py-1 text-xs rounded-full text-white premium-badge';
                        } else {
                            userTier.textContent = 'FREE';
                            userTier.className = 'ml-2 px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-700';
                        }
                    }

                    // Enable send button if message input has content
                    if (sendBtn) {
                        const messageInput = document.getElementById('message-input');
                        const hasMessage = messageInput && messageInput.value.trim().length > 0;
                        sendBtn.disabled = !hasMessage;
                    }
                } else {
                    // User is not logged in
                    if (userInfo) userInfo.classList.add('hidden');
                    if (loginBtn) loginBtn.classList.remove('hidden');
                    if (logoutBtn) logoutBtn.classList.add('hidden');
                    if (loginRequired) loginRequired.classList.remove('hidden');
                    if (messageForm) messageForm.classList.add('hidden');
                }
            }

            async sendMessage() {
                if (!this.currentUser) {
                    this.showError('Please login to send messages');
                    return;
                }

                const messageInput = document.getElementById('message-input');
                const sendBtn = document.getElementById('send-btn');
                const message = messageInput.value.trim();

                if (!message) {
                    this.showError('Please enter a message');
                    return;
                }

                console.log('ðŸ“¤ Sending message:', message);

                // Disable send button and show loading state
                sendBtn.disabled = true;
                sendBtn.textContent = 'Sending...';

                try {
                    const response = await fetch('/api/auth?action=chat-message', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({ message })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('âœ… Message sent successfully');
                        
                        // Clear input
                        messageInput.value = '';
                        document.getElementById('char-count').textContent = '0/1000';
                        
                        // Refresh messages and stats
                        await this.loadMessages();
                        await this.loadStats();
                        
                        this.showSuccess('Message sent successfully!');
                    } else {
                        const error = await response.json();
                        this.showError(error.error || 'Failed to send message');
                    }
                } catch (error) {
                    console.error('âŒ Send message failed:', error);
                    this.showError('Failed to send message. Please try again.');
                } finally {
                    sendBtn.disabled = false;
                    sendBtn.textContent = 'Send Message';
                }
            }

            async deleteMessage(messageId) {
                if (!confirm('Are you sure you want to delete this message?')) return;

                try {
                    const response = await fetch(`/api/auth?action=chat-delete&messageId=${messageId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        console.log('âœ… Message deleted successfully');
                        await this.loadMessages();
                        await this.loadStats();
                        this.showSuccess('Message deleted successfully!');
                    } else {
                        const error = await response.json();
                        this.showError(error.error || 'Failed to delete message');
                    }
                } catch (error) {
                    console.error('âŒ Delete message failed:', error);
                    this.showError('Failed to delete message');
                }
            }

            async logout() {
                try {
                    await fetch('/api/auth?action=logout', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    this.currentUser = null;
                    this.updateUI();
                    this.showSuccess('Logged out successfully');
                } catch (error) {
                    console.error('âŒ Logout failed:', error);
                    this.showError('Logout failed');
                }
            }

            startPolling() {
                // Poll for new messages every 15 seconds
                this.pollingInterval = setInterval(async () => {
                    if (this.isInitialized) {
                        try {
                            await this.loadMessages();
                            await this.loadStats();
                        } catch (error) {
                            console.error('âŒ Polling failed:', error);
                        }
                    }
                }, 15000);
                
                console.log('â° Started polling for updates');
            }

            showError(message) {
                this.showNotification(message, 'error');
            }

            showSuccess(message) {
                this.showNotification(message, 'success');
            }

            showNotification(message, type) {
                const className = type === 'error' ? 
                    'fixed top-4 right-4 bg-red-500 text-white px-4 py-3 rounded-lg shadow-lg z-50' :
                    'fixed top-4 right-4 bg-green-500 text-white px-4 py-3 rounded-lg shadow-lg z-50';
                
                const notification = document.createElement('div');
                notification.className = className;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 5000);
            }
        }

        // Initialize the chat application
        const chat = new IsThisTheDipChat();
    </script>
</body>
</html>